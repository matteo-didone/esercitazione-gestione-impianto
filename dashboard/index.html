<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè≠ Dashboard IoT Industriale</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Dashboard CSS - Clean and Minimal */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #00d4ff, #5b86e5, #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #a0aec0;
            font-size: 1.1rem;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
        }

        .connection-status.connected {
            background: rgba(72, 187, 120, 0.8);
            color: white;
        }

        .connection-status.error {
            background: rgba(245, 101, 101, 0.8);
            color: white;
        }

        .connection-status.no-data {
            background: rgba(237, 137, 54, 0.8);
            color: white;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 212, 255, 0.3);
        }

        .kpi-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .kpi-label {
            color: #a0aec0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Status Colors */
        .status-online {
            color: #48bb78;
        }

        .status-warning {
            color: #ed8936;
        }

        .status-critical {
            color: #f56565;
        }

        .status-info {
            color: #4299e1;
        }

        .status-no-data {
            color: #a0aec0;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 400px;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-canvas {
            width: 100% !important;
            height: 300px !important;
            max-width: 800px !important;
            max-height: 300px !important;
        }

        .no-data-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #a0aec0;
            font-size: 1.1rem;
        }

        /* Machine Grid */
        .machine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .machine-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .machine-card.online {
            border-color: #48bb78;
        }

        .machine-card.warning {
            border-color: #ed8936;
        }

        .machine-card.critical {
            border-color: #f56565;
        }

        .machine-card.offline {
            border-color: #6c757d;
        }

        .machine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .machine-name {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .machine-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #a0aec0;
        }

        .machine-status {
            text-align: center;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Footer */
        .footer {
            text-align: center;
            color: #a0aec0;
            font-size: 0.9rem;
            margin-top: 30px;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .machine-grid {
                grid-template-columns: 1fr;
            }

            .machine-metrics {
                grid-template-columns: 1fr;
            }
        }

        /* Error Messages */
        .error-message {
            background: rgba(245, 101, 101, 0.2);
            border: 1px solid #f56565;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            color: #f56565;
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <h1 class="title">üè≠ Dashboard Industriale IoT</h1>
            <p class="subtitle">Dati Real-time da InfluxDB</p>
        </div>

        <!-- Connection Status -->
        <div class="connection-status" id="connectionStatus">
            <div class="loading"></div> Connessione...
        </div>

        <!-- Error Container -->
        <div id="errorContainer"></div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon">üè≠</div>
                <div class="kpi-value" id="plant-status">
                    <div class="loading"></div>
                </div>
                <div class="kpi-label">Stato Impianto</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon">üì¶</div>
                <div class="kpi-value" id="pieces-count">
                    <div class="loading"></div>
                </div>
                <div class="kpi-label">Pezzi Lavorati (24h)</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon">üö®</div>
                <div class="kpi-value" id="alerts-count">
                    <div class="loading"></div>
                </div>
                <div class="kpi-label">Allarmi Attivi</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-icon">‚ö°</div>
                <div class="kpi-value" id="total-power">
                    <div class="loading"></div>
                </div>
                <div class="kpi-label">Potenza Totale (kW)</div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">üå°Ô∏è Temperature Macchine (ultimi 30 min)</h3>
                <canvas id="tempChart" class="chart-canvas"></canvas>
                <div id="tempChartNoData" class="no-data-message" style="display: none;">
                    üìä Nessun dato di temperatura disponibile
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">‚ö° Consumo Energetico (ultimi 30 min)</h3>
                <canvas id="powerChart" class="chart-canvas"></canvas>
                <div id="powerChartNoData" class="no-data-message" style="display: none;">
                    üìä Nessun dato di potenza disponibile
                </div>
            </div>
        </div>

        <!-- Machine Status -->
        <div class="machine-section">
            <h3 style="font-size: 1.4rem; margin-bottom: 20px; padding-left: 10px; border-left: 4px solid #48bb78;">
                üè≠ Stato Macchine (ultimi 5 minuti)
            </h3>
            <div class="machine-grid" id="machineGrid">
                <!-- Machines will be populated dynamically -->
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Ultimo aggiornamento: <span id="last-update">--:--:--</span> | Auto-refresh ogni 10 secondi</p>
            <p>üìä Dati Real-time da InfluxDB | üîÑ Solo dati reali, nessuna simulazione</p>
        </div>
    </div>

    <script>
        // REAL DATA ONLY Dashboard JavaScript
        const CONFIG = {
            influxdb: {
                url: 'http://localhost:8086',
                token: 'factory-token-2024',
                org: 'factory',
                bucket: 'industrial_data'
            },
            refresh_interval: 10000
        };

        // Global variables
        let charts = {};
        let isConnected = false;
        let lastUpdateTime = null;
        let hasRealData = false;

        /**
         * Initialize dashboard
         */
        async function initDashboard() {
            console.log('üöÄ Initializing Real Data Dashboard...');

            // Initialize charts
            initCharts();

            // Load initial data
            await updateAllData();

            // Setup auto-refresh
            setInterval(updateAllData, CONFIG.refresh_interval);

            console.log('‚úÖ Dashboard initialized');
        }

        /**
         * Initialize charts
         */
        function initCharts() {
            console.log('üìä Initializing charts...');

            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#ffffff' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#a0aec0' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { color: '#a0aec0' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            };

            try {
                // Temperature Chart
                const tempCanvas = document.getElementById('tempChart');
                if (tempCanvas) {
                    charts.temperature = new Chart(tempCanvas, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: []
                        },
                        options: {
                            ...chartConfig,
                            scales: {
                                ...chartConfig.scales,
                                y: {
                                    ...chartConfig.scales.y,
                                    title: {
                                        display: true,
                                        text: 'Temperatura (¬∞C)',
                                        color: '#ffffff'
                                    }
                                }
                            }
                        }
                    });
                }

                // Power Chart
                const powerCanvas = document.getElementById('powerChart');
                if (powerCanvas) {
                    charts.power = new Chart(powerCanvas, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: []
                        },
                        options: {
                            ...chartConfig,
                            scales: {
                                ...chartConfig.scales,
                                y: {
                                    ...chartConfig.scales.y,
                                    min: 0,
                                    title: {
                                        display: true,
                                        text: 'Potenza (kW)',
                                        color: '#ffffff'
                                    }
                                }
                            }
                        }
                    });
                }

                console.log('‚úÖ Charts initialized');

            } catch (error) {
                console.error('‚ùå Error initializing charts:', error);
            }
        }

        /**
         * Query InfluxDB for real data
         */
        async function queryInfluxDB(fluxQuery) {
            try {
                const response = await fetch(`${CONFIG.influxdb.url}/api/v2/query?org=${CONFIG.influxdb.org}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${CONFIG.influxdb.token}`,
                        'Content-Type': 'application/vnd.flux',
                        'Accept': 'application/csv'
                    },
                    body: fluxQuery
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const csvData = await response.text();
                return parseInfluxCSV(csvData);

            } catch (error) {
                console.error('InfluxDB Query Error:', error);
                return null;
            }
        }

        /**
         * Parse InfluxDB CSV response
         */
        function parseInfluxCSV(csvData) {
            const lines = csvData.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;

                const values = lines[i].split(',');
                const row = {};

                headers.forEach((header, index) => {
                    const cleanHeader = header.trim();
                    const cleanValue = values[index] ? values[index].trim() : '';

                    if (cleanValue !== '') {
                        if (!isNaN(cleanValue) && cleanValue !== '') {
                            row[cleanHeader] = parseFloat(cleanValue);
                        } else {
                            row[cleanHeader] = cleanValue;
                        }
                    }
                });

                if (Object.keys(row).length > 0) {
                    data.push(row);
                }
            }

            return data;
        }

        /**
         * Update KPIs with REAL data only
         */
        async function updateKPIs() {
            try {
                // Check if we have any recent data
                const recentDataQuery = `
                    from(bucket:"${CONFIG.influxdb.bucket}")
                    |> range(start: -5m)
                    |> limit(n: 1)
                `;

                const recentData = await queryInfluxDB(recentDataQuery);

                if (!recentData || recentData.length === 0) {
                    // No data available
                    document.getElementById('plant-status').innerHTML = '<span class="status-no-data">‚ö´ NO DATA</span>';
                    document.getElementById('pieces-count').innerHTML = '<span class="status-no-data">--</span>';
                    document.getElementById('alerts-count').innerHTML = '<span class="status-no-data">--</span>';
                    document.getElementById('total-power').innerHTML = '<span class="status-no-data">--</span>';

                    updateConnectionStatus(false, 'Nessun dato');
                    hasRealData = false;
                    return;
                }

                hasRealData = true;
                updateConnectionStatus(true);

                // Get pieces completed in last 24h
                const piecesQuery = `
                    from(bucket:"${CONFIG.influxdb.bucket}")
                    |> range(start: -24h)
                    |> filter(fn: (r) => r._measurement == "piece_tracking")
                    |> filter(fn: (r) => r.event_type == "deposit")
                    |> count()
                `;

                // Get current total power
                const powerQuery = `
                    from(bucket:"${CONFIG.influxdb.bucket}")
                    |> range(start: -5m)
                    |> filter(fn: (r) => r._measurement == "sensor_data")
                    |> filter(fn: (r) => r._field == "power")
                    |> group(columns: ["machine"])
                    |> last()
                    |> sum()
                `;

                // Get current alerts (temperature > 80)
                const alertsQuery = `
                    from(bucket:"${CONFIG.influxdb.bucket}")
                    |> range(start: -5m)
                    |> filter(fn: (r) => r._measurement == "sensor_data")
                    |> filter(fn: (r) => r._field == "temperature")
                    |> filter(fn: (r) => r._value > 80.0)
                    |> group(columns: ["machine"])
                    |> count()
                `;

                const [piecesData, powerData, alertsData] = await Promise.all([
                    queryInfluxDB(piecesQuery),
                    queryInfluxDB(powerQuery),
                    queryInfluxDB(alertsQuery)
                ]);

                // Update Plant Status
                document.getElementById('plant-status').innerHTML = '<span class="status-online">üü¢ ONLINE</span>';

                // Update Pieces Count
                const piecesCount = piecesData && piecesData.length > 0 ? piecesData[0]._value || 0 : 0;
                document.getElementById('pieces-count').innerHTML = `<span class="status-info">${piecesCount}</span>`;

                // Update Alerts Count
                const alertsCount = alertsData && alertsData.length > 0 ? alertsData.length : 0;
                const alertsEl = document.getElementById('alerts-count');
                if (alertsCount === 0) {
                    alertsEl.innerHTML = '<span class="status-online">0</span>';
                } else {
                    alertsEl.innerHTML = `<span class="status-critical">${alertsCount}</span>`;
                }

                // Update Total Power
                const totalPower = powerData && powerData.length > 0 ? (powerData[0]._value || 0).toFixed(1) : '0.0';
                document.getElementById('total-power').innerHTML = `<span class="status-info">${totalPower}</span>`;

            } catch (error) {
                console.error('Error updating KPIs:', error);
                showError('Errore query InfluxDB per KPI');
            }
        }

        /**
         * DEBUG: Update temperature chart to show ALL fields
         */
        async function updateTemperatureChart() {
            try {
                if (!charts.temperature) return;

                // DEBUG: Query ALL fields to see what we have
                const debugQuery = `
                    from(bucket:"${CONFIG.influxdb.bucket}")
                    |> range(start: -30m)
                    |> filter(fn: (r) => r._measurement == "sensor_data")
                    |> aggregateWindow(every: 2m, fn: mean, createEmpty: false)
                    |> pivot(rowKey:["_time"], columnKey: ["_field", "machine"], valueColumn: "_value")
                `;

                console.log("üîç DEBUG: Querying all sensor data fields...");
                const tempData = await queryInfluxDB(debugQuery);

                if (!tempData || tempData.length === 0) {
                    document.getElementById('tempChart').style.display = 'none';
                    document.getElementById('tempChartNoData').style.display = 'flex';
                    console.log("‚ùå No sensor data found");
                    return;
                }

                console.log("üîç DEBUG: Raw sensor data:", tempData[0]);
                console.log("üîç DEBUG: Available columns:", Object.keys(tempData[0]));

                document.getElementById('tempChart').style.display = 'block';
                document.getElementById('tempChartNoData').style.display = 'none';

                // Extract temperature-like fields
                const allKeys = Object.keys(tempData[0]);
                const tempFields = allKeys.filter(key =>
                    key.includes('temperature') ||
                    key.includes('temp') ||
                    (key.includes('_') && !['_time', 'result', 'table'].includes(key) &&
                        tempData[0][key] && tempData[0][key] < 200) // Realistic temp values
                );

                console.log("üîç DEBUG: Temperature-like fields:", tempFields);

                // If no temperature fields, show first numeric field for debugging
                let fieldsToShow = tempFields;
                if (fieldsToShow.length === 0) {
                    fieldsToShow = allKeys.filter(key =>
                        !['_time', 'result', 'table'].includes(key) &&
                        typeof tempData[0][key] === 'number'
                    ).slice(0, 4); // Max 4 fields
                    console.log("‚ö†Ô∏è No temperature fields, showing:", fieldsToShow);
                }

                const labels = tempData.map(row => {
                    const date = new Date(row._time);
                    return date.toLocaleTimeString('it-IT', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                });

                const colors = ['#48bb78', '#ed8936', '#4299e1', '#9f7aea'];
                const datasets = fieldsToShow.map((field, index) => ({
                    label: field,
                    data: tempData.map(row => row[field] || null),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.4,
                    borderWidth: 3
                }));

                charts.temperature.data.labels = labels;
                charts.temperature.data.datasets = datasets;
                charts.temperature.update('none');

            } catch (error) {
                console.error('Error updating temperature chart:', error);
            }
        }

        /**
         * Update power chart with REAL data only
         */
        async function updatePowerChart() {
            try {
                if (!charts.power) return;

                const powerQuery = `
                    from(bucket:"${CONFIG.influxdb.bucket}")
                    |> range(start: -30m)
                    |> filter(fn: (r) => r._measurement == "sensor_data")
                    |> filter(fn: (r) => r._field == "power")
                    |> aggregateWindow(every: 2m, fn: sum, createEmpty: false)
                `;

                const powerData = await queryInfluxDB(powerQuery);

                if (!powerData || powerData.length === 0) {
                    // No power data
                    document.getElementById('powerChart').style.display = 'none';
                    document.getElementById('powerChartNoData').style.display = 'flex';
                    return;
                }

                document.getElementById('powerChart').style.display = 'block';
                document.getElementById('powerChartNoData').style.display = 'none';

                const labels = powerData.map(row => {
                    const date = new Date(row._time);
                    return date.toLocaleTimeString('it-IT', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                });

                const values = powerData.map(row => row._value || 0);

                charts.power.data.labels = labels;
                charts.power.data.datasets = [{
                    label: 'Consumo Totale',
                    data: values,
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0, 212, 255, 0.2)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }];

                charts.power.update('none');

            } catch (error) {
                console.error('Error updating power chart:', error);
            }
        }

        /**
         * Update machine status with REAL data only
         */
        async function updateMachineStatus() {
            try {
                const machineQuery = `
                    from(bucket:"${CONFIG.influxdb.bucket}")
                    |> range(start: -5m)
                    |> filter(fn: (r) => r._measurement == "sensor_data")
                    |> filter(fn: (r) => r._field == "temperature" or r._field == "power")
                    |> group(columns: ["machine", "_field"])
                    |> last()
                    |> pivot(rowKey:["machine"], columnKey: ["_field"], valueColumn: "_value")
                `;

                const machineData = await queryInfluxDB(machineQuery);

                const machineGrid = document.getElementById('machineGrid');
                machineGrid.innerHTML = '';

                if (!machineData || machineData.length === 0) {
                    machineGrid.innerHTML = '<div class="no-data-message">üìä Nessun dato macchine disponibile</div>';
                    return;
                }

                for (const machine of machineData) {
                    if (!machine.machine) continue;

                    const temp = machine.temperature || 0;
                    const power = machine.power || 0;

                    let statusClass = 'online';
                    let statusText = 'üü¢ Operativa';
                    let tempClass = 'status-online';

                    if (temp > 85) {
                        statusClass = 'critical';
                        statusText = 'üî¥ Critica';
                        tempClass = 'status-critical';
                    } else if (temp > 70) {
                        statusClass = 'warning';
                        statusText = 'üü° Attenzione';
                        tempClass = 'status-warning';
                    } else if (power < 0.1) {
                        statusClass = 'offline';
                        statusText = '‚ö´ Idle';
                        tempClass = 'status-info';
                    }

                    const machineCard = document.createElement('div');
                    machineCard.className = `machine-card ${statusClass} fade-in`;
                    machineCard.innerHTML = `
                        <div class="machine-header">
                            <div class="machine-name">${machine.machine}</div>
                        </div>
                        <div class="machine-metrics">
                            <div class="metric">
                                <div class="metric-value ${tempClass}">${temp.toFixed(1)}¬∞C</div>
                                <div class="metric-label">Temperatura</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value status-info">${power.toFixed(1)} kW</div>
                                <div class="metric-label">Potenza</div>
                            </div>
                        </div>
                        <div class="machine-status">${statusText}</div>
                    `;

                    machineGrid.appendChild(machineCard);
                }

            } catch (error) {
                console.error('Error updating machine status:', error);
            }
        }

        /**
         * Update connection status
         */
        function updateConnectionStatus(connected, message = '') {
            const statusEl = document.getElementById('connectionStatus');
            isConnected = connected;

            if (connected && hasRealData) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = 'üü¢ Connesso - Dati Real-time';
            } else if (connected && !hasRealData) {
                statusEl.className = 'connection-status no-data';
                statusEl.innerHTML = 'üü° Connesso - Nessun dato';
            } else {
                statusEl.className = 'connection-status error';
                statusEl.innerHTML = `üî¥ ${message || 'Errore connessione'}`;
            }
        }

        /**
         * Show error message
         */
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">‚ö†Ô∏è ${message}</div>`;
            updateConnectionStatus(false, 'Errore');
        }

        /**
         * Clear errors
         */
        function clearErrors() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        /**
         * Update all data - REAL DATA ONLY
         */
        async function updateAllData() {
            try {
                clearErrors();

                console.log('üìä Updating all data from InfluxDB...');

                // Update all sections with real data
                await Promise.all([
                    updateKPIs(),
                    updateTemperatureChart(),
                    updatePowerChart(),
                    updateMachineStatus()
                ]);

                lastUpdateTime = new Date();
                document.getElementById('last-update').textContent =
                    lastUpdateTime.toLocaleTimeString('it-IT');

                if (hasRealData) {
                    console.log('‚úÖ Real data updated successfully');
                } else {
                    console.log('‚ö†Ô∏è No real data available');
                }

            } catch (error) {
                console.error('‚ùå Error updating data:', error);
                showError('Errore connessione InfluxDB');
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', initDashboard);

    </script>
</body>

</html>